<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Support Ticket System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .health-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 2s infinite;
    }

    .health-indicator.healthy {
      background: #28a745;
      box-shadow: 0 0 5px #28a745;
    }

    .health-indicator.unhealthy {
      background: #dc3545;
      box-shadow: 0 0 5px #dc3545;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
    }

    button {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #764ba2;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .tickets-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .ticket-item {
      background: #f5f5f5;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }

    .ticket-item h3 {
      color: #333;
      margin-bottom: 8px;
    }

    .ticket-item p {
      color: #666;
      font-size: 0.9em;
      margin: 5px 0;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 0.85em;
      font-weight: 600;
      margin-right: 5px;
      margin-bottom: 8px;
    }

    .status-new { background: #e7f3ff; color: #004085; }
    .status-in_progress { background: #fff3cd; color: #856404; }
    .status-waiting_customer { background: #f0e4ff; color: #5a3d96; }
    .status-resolved { background: #d4edda; color: #155724; }
    .status-closed { background: #d1d5db; color: #374151; }

    .priority-urgent { background: #f8d7da; color: #721c24; }
    .priority-high { background: #fff3cd; color: #856404; }
    .priority-medium { background: #cfe2ff; color: #084298; }
    .priority-low { background: #d1e7dd; color: #0a3622; }

    .category-account_access { background: #e3f2fd; color: #1565c0; }
    .category-technical_issue { background: #f3e5f5; color: #6a1b9a; }
    .category-billing_question { background: #fff3e0; color: #e65100; }
    .category-feature_request { background: #e0f2f1; color: #004d40; }
    .category-bug_report { background: #ffebee; color: #c62828; }
    .category-other { background: #f1f1f1; color: #424242; }

    .message {
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .loading {
      text-align: center;
      color: #667eea;
      font-weight: bold;
      padding: 20px;
    }

    .empty-state {
      text-align: center;
      color: #999;
      padding: 30px 20px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .modal-header h2 {
      margin: 0;
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: auto;
    }

    .close-btn:hover {
      color: #333;
    }

    .modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      padding: 12px;
    }

    .modal-buttons button:last-child {
      background: #6c757d;
    }

    .modal-buttons button:last-child:hover {
      background: #5a6268;
    }

    .filter-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .action-buttons button {
      padding: 8px;
      font-size: 0.9em;
    }

    .confidence-score {
      display: inline-block;
      padding: 3px 6px;
      border-radius: 3px;
      background: #e8eaf6;
      color: #3f51b5;
      font-size: 0.85em;
      font-weight: 600;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .stat-box {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      border-left: 4px solid #667eea;
    }

    .stat-box p {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-box .number {
      font-size: 1.8em;
      font-weight: bold;
      color: #667eea;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }

    .tab-button {
      padding: 10px 15px;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      width: auto;
      margin-bottom: -2px;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.8em;
      }

      .filter-controls {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        ðŸŽ« Customer Support Ticket System
        <span id="healthIndicator" class="health-indicator" title="Server Status"></span>
      </h1>
      <p>Manage and track support tickets efficiently</p>
    </header>

    <div class="main-grid">
      <!-- Dashboard Stats -->
      <div class="card full-width">
        <h2>Dashboard</h2>
        <div id="statsMessage" class="message"></div>
        <button onclick="loadStats()" style="margin-bottom: 15px;">Refresh Stats</button>
        <div id="statsContainer">
          <div class="empty-state">Click "Refresh Stats" to load</div>
        </div>
      </div>

      <!-- Create Ticket -->
      <div class="card">
        <h2>Create Ticket</h2>
        <div id="createMessage" class="message"></div>
        <form id="ticketForm">
          <div class="form-group">
            <label for="customerName">Customer Name:</label>
            <input type="text" id="customerName" placeholder="John Doe" required>
          </div>
          <div class="form-group">
            <label for="customerEmail">Email:</label>
            <input type="email" id="customerEmail" placeholder="john@example.com" required>
          </div>
          <div class="form-group">
            <label for="customerId">Customer ID:</label>
            <input type="text" id="customerId" placeholder="cust_001" required>
          </div>
          <div class="form-group">
            <label for="subject">Subject:</label>
            <input type="text" id="subject" placeholder="Issue subject" required>
          </div>
          <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" placeholder="Describe the issue (min 10 chars)" required></textarea>
          </div>
          <div class="form-group">
            <label for="category">Select Category:</label>
            <select id="category" required>
              <option value="account_access">Account Access</option>
              <option value="technical_issue">Technical Issue</option>
              <option value="billing_question">Billing Question</option>
              <option value="feature_request">Feature Request</option>
              <option value="bug_report">Bug Report</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="priority">Select Priority:</label>
            <select id="priority" required>
              <option value="urgent">Urgent</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="autoClassify" style="width: auto; margin-right: 8px;">
              Auto-classify this ticket?
            </label>
          </div>
          <button type="submit">Create Ticket</button>
        </form>
      </div>

      <!-- List Tickets -->
      <div class="card">
        <h2>Tickets</h2>
        <div id="ticketsMessage" class="message"></div>
        
        <div class="tabs">
          <button class="tab-button active" onclick="switchTab('list')">List All</button>
          <button class="tab-button" onclick="switchTab('filter')">Filter</button>
          <button class="tab-button" onclick="switchTab('classify')">Auto-Classify</button>
          <button class="tab-button" onclick="switchTab('import')">Bulk Import</button>
          <button class="tab-button" onclick="switchTab('audit')">Audit Logs</button>
          <button class="tab-button" onclick="switchTab('analytics')">Analytics</button>
        </div>

        <!-- List Tab -->
        <div id="list" class="tab-content active">
          <button onclick="loadTickets()" style="margin-bottom: 15px;">Load Tickets</button>
          <div id="ticketsList" class="tickets-list">
            <div class="empty-state">Click "Load Tickets" to view</div>
          </div>
        </div>

        <!-- Filter Tab -->
        <div id="filter" class="tab-content">
          <div class="filter-controls">
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.9em; margin-bottom: 3px;">Category:</label>
              <select id="filterCategory">
                <option value="">All</option>
                <option value="account_access">Account Access</option>
                <option value="technical_issue">Technical Issue</option>
                <option value="billing_question">Billing Question</option>
                <option value="feature_request">Feature Request</option>
                <option value="bug_report">Bug Report</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.9em; margin-bottom: 3px;">Priority:</label>
              <select id="filterPriority">
                <option value="">All</option>
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.9em; margin-bottom: 3px;">Status:</label>
              <select id="filterStatus">
                <option value="">All</option>
                <option value="new">New</option>
                <option value="in_progress">In Progress</option>
                <option value="waiting_customer">Waiting Customer</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.9em; margin-bottom: 3px;">Customer:</label>
              <input type="text" id="filterCustomer" placeholder="Customer ID">
            </div>
          </div>
          <button onclick="filterTickets()">Apply Filters</button>
          <div id="filteredTickets" class="tickets-list" style="margin-top: 15px;">
            <div class="empty-state">Apply filters to search</div>
          </div>
        </div>

        <!-- Auto-Classify Tab -->
        <div id="classify" class="tab-content">
          <div class="form-group">
            <label for="classifyTicketId">Ticket ID:</label>
            <input type="text" id="classifyTicketId" placeholder="Paste ticket ID here">
          </div>
          <button onclick="classifyTicket()">Auto-Classify</button>
          <div id="classifyResult" style="margin-top: 20px; display: none;">
            <div class="ticket-item">
              <p><strong>Ticket ID:</strong> <span id="classifyId"></span></p>
              <p><strong>Category:</strong> <span id="classifyCategory" class="badge"></span></p>
              <p><strong>Priority:</strong> <span id="classifyPriority" class="badge"></span></p>
              <p><strong>Confidence:</strong> <span id="classifyConfidence" class="confidence-score"></span></p>
              <p><strong>Reasoning:</strong> <span id="classifyReasoning"></span></p>
              <p><strong>Keywords Found:</strong> <span id="classifyKeywords"></span></p>
            </div>
          </div>
        </div>

        <!-- Bulk Import Tab -->
        <div id="import" class="tab-content">
          <div class="form-group">
            <label for="importFileType">Select Format</label>
            <select id="importFileType" required>
              <option value="csv">CSV</option>
              <option value="json">JSON</option>
              <option value="xml">XML</option>
            </select>
          </div>
          <div class="form-group">
            <label for="importFile">Select File:</label>
            <input type="file" id="importFile" accept=".csv,.json,.xml" required>
          </div>
          <p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">
            ðŸ“Œ Tip: Use sample files from tests/fixtures folder or upload your own CSV, JSON, or XML files
          </p>
          <button onclick="importFile()">Import Tickets</button>
          <div id="importMessage" class="message" style="margin-top: 15px;"></div>
          <div id="importResults" style="margin-top: 20px; display: none;">
            <div style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
              <h4 style="margin-bottom: 10px;">Import Summary:</h4>
              <p><strong>Total Records:</strong> <span id="importTotal">0</span></p>
              <p><strong>Successful:</strong> <span id="importSuccessful" style="color: #155724; font-weight: bold;">0</span></p>
              <p><strong>Failed:</strong> <span id="importFailed" style="color: #721c24; font-weight: bold;">0</span></p>
              <div id="importFailedDetails" style="margin-top: 10px; display: none; max-height: 200px; overflow-y: auto;">
                <p style="color: #721c24; font-weight: bold; margin-bottom: 5px;">Failed Records:</p>
                <div id="failedList" style="font-size: 0.9em;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="audit" class="tab-content">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 15px;">
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.9em; margin-bottom: 3px;">Filter by Ticket ID:</label>
              <input type="text" id="auditTicketId" placeholder="Enter ticket ID">
            </div>
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.9em; margin-bottom: 3px;">Filter by Action:</label>
              <select id="auditAction">
                <option value="">All Actions</option>
                <option value="auto_classify_on_create">Auto Classify on Create</option>
                <option value="manual_classify">Manual Classify</option>
              </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button onclick="loadAuditLogs()" style="width: 100%;">Load Logs</button>
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button onclick="clearAuditFilters()" style="width: auto; background: #6c757d; padding: 10px 20px;">Clear</button>
            </div>
          </div>
          <div id="auditLogsList" class="tickets-list" style="max-height: 500px;">
            <div class="empty-state">Click "Load Logs" to view audit trail</div>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
          <button onclick="loadAnalytics()" style="margin-bottom: 20px;">Load Analytics</button>
          <div id="analyticsContainer">
            <div class="empty-state">Click "Load Analytics" to view classification statistics</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Ticket Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Ticket</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="editMessage" class="message"></div>
      <form id="editForm">
        <div class="form-group">
          <label for="editStatus">Status:</label>
          <select id="editStatus" required>
            <option value="new">New</option>
            <option value="in_progress">In Progress</option>
            <option value="waiting_customer">Waiting Customer</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editCategory">Category:</label>
          <select id="editCategory" required>
            <option value="account_access">Account Access</option>
            <option value="technical_issue">Technical Issue</option>
            <option value="billing_question">Billing Question</option>
            <option value="feature_request">Feature Request</option>
            <option value="bug_report">Bug Report</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editPriority">Priority:</label>
          <select id="editPriority" required>
            <option value="urgent">Urgent</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editAssignedTo">Assigned To:</label>
          <input type="text" id="editAssignedTo" placeholder="Support agent name">
        </div>
        <div class="form-group">
          <label for="editSubject">Subject:</label>
          <input type="text" id="editSubject" required>
        </div>
        <div class="form-group">
          <label for="editDescription">Description:</label>
          <textarea id="editDescription" required></textarea>
        </div>
        <div class="modal-buttons">
          <button type="submit">Save Changes</button>
          <button type="button" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    let allTickets = [];

    // Initialize on page load
    window.addEventListener('load', () => {
      checkHealth();
      loadTickets();
      loadStats();
      // Check health every 30 seconds
      setInterval(checkHealth, 30000);
    });

    // Check server health
    async function checkHealth() {
      const indicator = document.getElementById('healthIndicator');
      try {
        const response = await fetch('http://localhost:3000/health');
        const data = await response.json();
        
        if (response.ok && data.status === 'healthy') {
          indicator.className = 'health-indicator healthy';
          indicator.title = 'Server: Online';
        } else {
          indicator.className = 'health-indicator unhealthy';
          indicator.title = 'Server: Error';
        }
      } catch (error) {
        indicator.className = 'health-indicator unhealthy';
        indicator.title = 'Server: Offline';
      }
    }

    // Create Ticket
    document.getElementById('ticketForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const autoClassify = document.getElementById('autoClassify').checked;
      const ticketData = {
        customer_name: document.getElementById('customerName').value,
        customer_email: document.getElementById('customerEmail').value,
        customer_id: document.getElementById('customerId').value,
        subject: document.getElementById('subject').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value,
        status: 'new'
      };

      try {
        const url = autoClassify ? `${API_URL}/tickets?auto_classify=true` : `${API_URL}/tickets`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ticketData)
        });

        const data = await response.json();
        const msg = document.getElementById('createMessage');

        if (response.ok) {
          let successMsg = `âœ“ Ticket created! ID: ${data.ticket.id}`;
          if (data.classification) {
            successMsg += ` | Classified as: ${data.classification.category} (${(data.classification.confidence * 100).toFixed(1)}% confidence)`;
          }
          msg.textContent = successMsg;
          msg.className = 'message success';
          document.getElementById('ticketForm').reset();
          loadTickets();
          loadStats();
        } else {
          const errors = data.details ? data.details.join(', ') : data.error;
          msg.textContent = `âœ— Error: ${errors}`;
          msg.className = 'message error';
        }
      } catch (error) {
        showError('createMessage', error.message);
      }
    });

    // Load all tickets
    async function loadTickets() {
      try {
        const response = await fetch(`${API_URL}/tickets`);
        const data = await response.json();
        
        if (data.success) {
          allTickets = data.tickets || [];
          renderTickets(allTickets, 'ticketsList');
        } else {
          showError('ticketsMessage', 'Failed to load tickets');
        }
      } catch (error) {
        showError('ticketsMessage', error.message);
      }
    }

    // Filter tickets
    async function filterTickets() {
      const filters = {
        category: document.getElementById('filterCategory').value,
        priority: document.getElementById('filterPriority').value,
        status: document.getElementById('filterStatus').value,
        customer_id: document.getElementById('filterCustomer').value
      };

      // Remove empty filters
      Object.keys(filters).forEach(key => !filters[key] && delete filters[key]);

      try {
        const query = new URLSearchParams(filters).toString();
        const response = await fetch(`${API_URL}/tickets${query ? '?' + query : ''}`);
        const data = await response.json();
        
        if (data.success) {
          renderTickets(data.tickets || [], 'filteredTickets');
        } else {
          showError('ticketsMessage', 'Failed to filter tickets');
        }
      } catch (error) {
        showError('ticketsMessage', error.message);
      }
    }

    // Auto-classify ticket
    async function classifyTicket() {
      const ticketId = document.getElementById('classifyTicketId').value.trim();
      if (!ticketId) {
        showError('ticketsMessage', 'Please enter a ticket ID');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/tickets/${ticketId}/auto-classify`, {
          method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
          const classification = data.classification;
          document.getElementById('classifyId').textContent = ticketId;
          document.getElementById('classifyCategory').textContent = classification.category;
          document.getElementById('classifyCategory').className = `badge category-${classification.category}`;
          document.getElementById('classifyPriority').textContent = classification.priority;
          document.getElementById('classifyPriority').className = `badge priority-${classification.priority}`;
          document.getElementById('classifyConfidence').textContent = (classification.confidence * 100).toFixed(1) + '%';
          document.getElementById('classifyReasoning').textContent = classification.reasoning;
          document.getElementById('classifyKeywords').textContent = classification.keywords_found.join(', ') || 'None';
          document.getElementById('classifyResult').style.display = 'block';
        } else {
          showError('ticketsMessage', data.error || 'Failed to classify ticket');
        }
      } catch (error) {
        showError('ticketsMessage', error.message);
      }
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/tickets`);
        const data = await response.json();

        if (data.success) {
          const tickets = data.tickets || [];
          const stats = calculateStats(tickets);
          renderStats(stats);
        }
      } catch (error) {
        showError('statsMessage', error.message);
      }
    }

    // Calculate statistics
    function calculateStats(tickets) {
      const stats = {
        total: tickets.length,
        byStatus: {},
        byPriority: {},
        byCategory: {}
      };

      tickets.forEach(ticket => {
        stats.byStatus[ticket.status] = (stats.byStatus[ticket.status] || 0) + 1;
        stats.byPriority[ticket.priority] = (stats.byPriority[ticket.priority] || 0) + 1;
        stats.byCategory[ticket.category] = (stats.byCategory[ticket.category] || 0) + 1;
      });

      return stats;
    }

    // Render statistics
    function renderStats(stats) {
      const container = document.getElementById('statsContainer');
      let html = '<div class="stats-grid">';
      html += `<div class="stat-box"><p>Total Tickets</p><div class="number">${stats.total}</div></div>`;
      html += `<div class="stat-box"><p>New</p><div class="number">${stats.byStatus.new || 0}</div></div>`;
      html += `<div class="stat-box"><p>In Progress</p><div class="number">${stats.byStatus.in_progress || 0}</div></div>`;
      html += `<div class="stat-box"><p>Resolved</p><div class="number">${stats.byStatus.resolved || 0}</div></div>`;
      html += '</div>';
      container.innerHTML = html;
    }

    // Render tickets
    function renderTickets(tickets, elementId) {
      const container = document.getElementById(elementId);
      
      if (tickets.length === 0) {
        container.innerHTML = '<div class="empty-state">No tickets found</div>';
        return;
      }

      container.innerHTML = tickets.map(ticket => `
        <div class="ticket-item">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
            <h3 style="margin: 0; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 200px;">ID: ${ticket.id}</h3>
            <button onclick="copyToClipboard('${ticket.id}')" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.85em; white-space: nowrap;">Copy ID</button>
          </div>
          <div>
            <span class="badge category-${ticket.category}">${ticket.category}</span>
            <span class="badge priority-${ticket.priority}">${ticket.priority}</span>
            <span class="badge status-${ticket.status}">${ticket.status}</span>
          </div>
          <p><strong>Subject:</strong> ${ticket.subject}</p>
          <p><strong>Customer:</strong> ${ticket.customer_name} (${ticket.customer_email})</p>
          <p><strong>Description:</strong> ${ticket.description.substring(0, 100)}...</p>
          <p><strong>Created:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
          <div class="action-buttons">
            <button onclick="editTicket('${ticket.id}')">Edit</button>
            <button onclick="deleteTicket('${ticket.id}')" style="background: #dc3545;">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Edit ticket
    async function editTicket(ticketId) {
      try {
        const response = await fetch(`${API_URL}/tickets/${ticketId}`);
        const data = await response.json();
        
        if (data.success) {
          const ticket = data.ticket;
          document.getElementById('editStatus').value = ticket.status;
          document.getElementById('editCategory').value = ticket.category;
          document.getElementById('editPriority').value = ticket.priority;
          document.getElementById('editAssignedTo').value = ticket.assigned_to || '';
          document.getElementById('editSubject').value = ticket.subject;
          document.getElementById('editDescription').value = ticket.description;
          
          // Store ticket ID for submission
          document.getElementById('editForm').dataset.ticketId = ticketId;
          
          document.getElementById('editModal').classList.add('active');
        } else {
          showError('ticketsMessage', 'Failed to load ticket');
        }
      } catch (error) {
        showError('ticketsMessage', error.message);
      }
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      document.getElementById('editForm').reset();
    }

    // Handle edit form submission
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const ticketId = e.target.dataset.ticketId;
      const updateData = {
        status: document.getElementById('editStatus').value,
        category: document.getElementById('editCategory').value,
        priority: document.getElementById('editPriority').value,
        assigned_to: document.getElementById('editAssignedTo').value,
        subject: document.getElementById('editSubject').value,
        description: document.getElementById('editDescription').value
      };

      try {
        const response = await fetch(`${API_URL}/tickets/${ticketId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });

        const data = await response.json();
        const msg = document.getElementById('editMessage');

        if (response.ok) {
          msg.textContent = 'âœ“ Ticket updated successfully!';
          msg.className = 'message success';
          setTimeout(() => {
            closeEditModal();
            loadTickets();
            loadStats();
            showSuccess('ticketsMessage', 'âœ“ Ticket updated successfully!');
          }, 1000);
        } else {
          const errors = data.details ? data.details.join(', ') : data.error;
          msg.textContent = `âœ— Error: ${errors}`;
          msg.className = 'message error';
        }
      } catch (error) {
        document.getElementById('editMessage').textContent = `âœ— Error: ${error.message}`;
        document.getElementById('editMessage').className = 'message error';
      }
    });

    // Delete ticket
    async function deleteTicket(ticketId) {
      if (!confirm('Are you sure you want to delete this ticket?')) return;

      try {
        const response = await fetch(`${API_URL}/tickets/${ticketId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showSuccess('ticketsMessage', `âœ“ Ticket deleted successfully!`);
          loadTickets();
          loadStats();
        } else {
          showError('ticketsMessage', 'Failed to delete ticket');
        }
      } catch (error) {
        showError('ticketsMessage', error.message);
      }
    }

    // Import file
    async function importFile() {
      const fileType = document.getElementById('importFileType').value;
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];

      if (!fileType) {
        showError('importMessage', 'Please select a file type');
        return;
      }

      if (!file) {
        showError('importMessage', 'Please select a file to import');
        return;
      }

      try {
        const fileContent = await file.text();
        
        const response = await fetch(`${API_URL}/tickets/import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            file_content: fileContent,
            file_type: fileType
          })
        });

        const data = await response.json();
        const msg = document.getElementById('importMessage');

        if (response.ok || response.status === 207) {
          const summary = data.summary;
          document.getElementById('importTotal').textContent = summary.total;
          document.getElementById('importSuccessful').textContent = summary.successful;
          document.getElementById('importFailed').textContent = summary.failed;
          
          if (summary.failed > 0) {
            const failedList = data.failed_records.map(record => 
              `<p style="margin: 5px 0;"><strong>Record ${record.record_number}:</strong> ${record.errors.join(', ')}</p>`
            ).join('');
            document.getElementById('failedList').innerHTML = failedList;
            document.getElementById('importFailedDetails').style.display = 'block';
          } else {
            document.getElementById('importFailedDetails').style.display = 'none';
          }

          document.getElementById('importResults').style.display = 'block';
          msg.textContent = `âœ“ Import completed! ${summary.successful} tickets imported successfully.`;
          msg.className = 'message success';
          
          // Refresh ticket list
          setTimeout(() => {
            loadTickets();
            loadStats();
            fileInput.value = '';
            document.getElementById('importFileType').value = '';
          }, 1500);
        } else {
          const errors = data.details ? data.details.join(', ') : data.error;
          msg.textContent = `âœ— Import failed: ${errors}`;
          msg.className = 'message error';
        }
      } catch (error) {
        showError('importMessage', error.message);
      }
    }

    // Tab switching
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // Show error
    function showError(elementId, message) {
      const msg = document.getElementById(elementId);
      msg.textContent = `âœ— Error: ${message}`;
      msg.className = 'message error';
    }

    // Show success
    function showSuccess(elementId, message) {
      const msg = document.getElementById(elementId);
      msg.textContent = message;
      msg.className = 'message success';
    }

    // Load audit logs
    async function loadAuditLogs() {
      const ticketId = document.getElementById('auditTicketId').value.trim();
      const action = document.getElementById('auditAction').value;
      
      try {
        let url = `${API_URL}/audit-logs`;
        const params = new URLSearchParams();
        if (ticketId) params.append('ticket_id', ticketId);
        if (action) params.append('action', action);
        if (params.toString()) url += '?' + params.toString();

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          renderAuditLogs(data.logs || []);
        } else {
          showError('ticketsMessage', 'Failed to load audit logs');
        }
      } catch (error) {
        showError('ticketsMessage', error.message);
      }
    }

    // Render audit logs
    function renderAuditLogs(logs) {
      const container = document.getElementById('auditLogsList');
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state">No audit logs found</div>';
        return;
      }

      container.innerHTML = logs.map(log => `
        <div class="ticket-item">
          <p><strong>Timestamp:</strong> ${new Date(log.timestamp).toLocaleString()}</p>
          <p><strong>Ticket ID:</strong> <span style="word-break: break-all;">${log.ticketId}</span> <button onclick="copyToClipboard('${log.ticketId}')" style="background: #667eea; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; margin-left: 5px;">Copy</button></p>
          <p><strong>Action:</strong> <span class="badge" style="background: #e3f2fd; color: #1565c0;">${log.action}</span></p>
          <p><strong>Category:</strong> <span class="badge category-${log.classification.category}">${log.classification.category}</span></p>
          <p><strong>Priority:</strong> <span class="badge priority-${log.classification.priority}">${log.classification.priority}</span></p>
          <p><strong>Confidence:</strong> <span class="confidence-score">${(log.classification.confidence * 100).toFixed(1)}%</span></p>
          <p><strong>Reasoning:</strong> ${log.classification.reasoning}</p>
          <p><strong>Keywords Found:</strong> ${log.classification.keywords_found.join(', ') || 'None'}</p>
          <p><strong>Subject:</strong> ${log.ticket_subject}</p>
          <p><strong>Description:</strong> ${log.ticket_description_preview}...</p>
        </div>
      `).join('');
    }

    // Clear audit filters
    function clearAuditFilters() {
      document.getElementById('auditTicketId').value = '';
      document.getElementById('auditAction').value = '';
      document.getElementById('auditLogsList').innerHTML = '<div class="empty-state">Click "Load Logs" to view audit trail</div>';
    }

    // Load analytics
    async function loadAnalytics() {
      try {
        const response = await fetch(`${API_URL}/audit-stats`);
        const data = await response.json();

        if (data.success) {
          renderAnalytics(data.statistics);
        } else {
          showError('ticketsMessage', 'Failed to load analytics');
        }
      } catch (error) {
        showError('ticketsMessage', error.message);
      }
    }

    // Render analytics
    function renderAnalytics(stats) {
      const container = document.getElementById('analyticsContainer');
      
      let html = '<div style="margin-bottom: 30px;">';
      html += '<h3 style="color: #667eea; margin-bottom: 15px;">ðŸ“Š Classification Statistics</h3>';
      html += '<div class="stats-grid">';
      html += `<div class="stat-box"><p>Total Logs</p><div class="number">${stats.total_logs || stats.by_action ? Object.values(stats.by_action).reduce((a,b)=>a+b,0) : 0}</div></div>`;
      let avgConf = stats.average_confidence;
      if (avgConf !== undefined && !isNaN(avgConf)) {
        avgConf = (parseFloat(avgConf) * 100).toFixed(1) + '%';
      } else {
        avgConf = 'N/A';
      }
      html += `<div class="stat-box"><p>Avg Confidence</p><div class="number">${avgConf}</div></div>`;
      html += '</div></div>';

      // By Action
      html += '<div style="margin-bottom: 30px;">';
      html += '<h3 style="color: #667eea; margin-bottom: 15px;">ðŸŽ¬ By Action Type</h3>';
      html += '<div class="stats-grid">';
      if (stats.by_action) {
        Object.entries(stats.by_action).forEach(([action, count]) => {
          html += `<div class="stat-box"><p>${action.replace(/_/g, ' ')}</p><div class="number">${count}</div></div>`;
        });
      }
      html += '</div></div>';
      container.innerHTML = html;
    }

    // Show error
    function showError(elementId, message) {
      const msg = document.getElementById(elementId);
      msg.textContent = `âœ— Error: ${message}`;
      msg.className = 'message error';
    }

    // Show success
    function showSuccess(elementId, message) {
      const msg = document.getElementById(elementId);
      msg.textContent = message;
      msg.className = 'message success';
    }

    // Copy to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Ticket ID copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy to clipboard');
      });
    }
  </script>
</body>
</html>
